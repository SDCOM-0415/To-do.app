name: Build and Release

# åªå…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
on:
  workflow_dispatch:  # ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            executable_ext: .exe
          # - os: macos-latest
          #   platform: macos
          #   arch: universal2
          #   executable_ext: ""
          - os: ubuntu-22.04
            platform: linux
            arch: x64
            executable_ext: ""

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Read version
      id: version
      run: |
        VERSION=$(head -n 1 version)
        TAG_TYPE=$(tail -n 1 version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # æ ¹æ®æ ‡ç­¾ç±»å‹è®¾ç½®tag_name
        if [ "$TAG_TYPE" == "Pre-release" ]; then
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(date +%Y%m%d)
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä»Šå¤©çš„æ„å»ºï¼Œå¹¶è·å–æœ€æ–°çš„æ„å»ºæ¬¡æ•°
          BUILD_COUNT=1
          # è·å–æ‰€æœ‰ä»¥å½“å‰ç‰ˆæœ¬å’Œæ—¥æœŸå¼€å¤´çš„æ ‡ç­¾
          EXISTING_TAGS=$(git ls-remote --tags origin | grep "${VERSION}-${DATE}-" | sed -E "s/.*${VERSION}-${DATE}-([0-9]+).*/\1/" | sort -n)
          
          # å¦‚æœå­˜åœ¨æ ‡ç­¾ï¼Œè·å–æœ€å¤§å€¼å¹¶åŠ 1
          if [ ! -z "$EXISTING_TAGS" ]; then
            LATEST_COUNT=$(echo "$EXISTING_TAGS" | tail -n 1)
            if [ ! -z "$LATEST_COUNT" ]; then
              BUILD_COUNT=$((LATEST_COUNT + 1))
            fi
          fi
          
          # è®¾ç½®é¢„è§ˆç‰ˆæ ‡ç­¾
          TAG_NAME="${VERSION}-${DATE}-${BUILD_COUNT}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "artifact_name_windows=Todo-App-$VERSION-preview-Windows-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_macos=Todo-App-$VERSION-preview-macOS-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_linux=Todo-App-$VERSION-preview-Linux-x64" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          # æ­£å¼ç‰ˆæ ‡ç­¾
          TAG_NAME="${VERSION}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "artifact_name_windows=Todo-App-$VERSION-Windows-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_macos=Todo-App-$VERSION-macOS-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_linux=Todo-App-$VERSION-Linux-x64" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk python3-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # - name: Install DMG creation tools (macOS)
    #   if: matrix.platform == 'macos'
    #   run: |
    #     brew install create-dmg

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        # ç¡®ä¿tkinterå·²æ­£ç¡®å®‰è£…
        python -c "import tkinter; print(f'Tkinterå·²å®‰è£…ï¼Œç‰ˆæœ¬: {tkinter.TkVersion}')"
        
        # è·å–Tcl/Tkè·¯å¾„å¹¶æ·»åŠ åˆ°ç¯å¢ƒå˜é‡
        $tclPath = python -c "import tkinter, os; print(os.path.join(os.path.dirname(os.path.dirname(tkinter.__file__)), 'tcl'))"
        $tkPath = python -c "import tkinter, os; print(os.path.join(os.path.dirname(os.path.dirname(tkinter.__file__)), 'tk'))"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        $env:TCL_LIBRARY = "$tclPath\tcl8.6"
        $env:TK_LIBRARY = "$tkPath\tk8.6"
        
        # è¾“å‡ºç¯å¢ƒå˜é‡ä»¥ä¾¿è°ƒè¯•
        Write-Host "TCL_LIBRARY: $env:TCL_LIBRARY"
        Write-Host "TK_LIBRARY: $env:TK_LIBRARY"
        
        # è¾“å‡ºPythonå’Œä¾èµ–åº“ç‰ˆæœ¬ä¿¡æ¯
        python -c "import sys; print(f'Pythonç‰ˆæœ¬: {sys.version}')"
        python -c "import customtkinter; print(f'CustomTkinterç‰ˆæœ¬: {customtkinter.__version__}')"
        python -c "import tkinter; print(f'Tkinterç‰ˆæœ¬: {tkinter.TkVersion}')"
        python -c "import PIL; print(f'PILç‰ˆæœ¬: {PIL.__version__}')"
        
        # ç›´æ¥ä¿®æ”¹build.specæ–‡ä»¶ï¼Œæ·»åŠ è¿è¡Œæ—¶é’©å­ä»£ç 
        $specContent = Get-Content build.spec
        $hookCode = @'
# æ·»åŠ è¿è¡Œæ—¶é’©å­ä»£ç 
import os
import sys

def get_hook_code():
    return """
import os
import sys

# å¦‚æœæ˜¯æ‰“åŒ…ç¯å¢ƒï¼Œè®¾ç½®æ­£ç¡®çš„TCL/TKè·¯å¾„
if getattr(sys, 'frozen', False):
    base_dir = sys._MEIPASS
    # å°è¯•å¤šç§å¯èƒ½çš„è·¯å¾„
    possible_tcl_paths = [
        os.path.join(base_dir, '_tcl_data', 'tcl8.6'),
        os.path.join(base_dir, 'tcl', 'tcl8.6'),
        os.path.join(base_dir, 'tcl')
    ]
    possible_tk_paths = [
        os.path.join(base_dir, '_tcl_data', 'tk8.6'),
        os.path.join(base_dir, 'tk', 'tk8.6'),
        os.path.join(base_dir, 'tk')
    ]
    # æŸ¥æ‰¾æœ‰æ•ˆçš„è·¯å¾„
    for tcl_path in possible_tcl_paths:
        if os.path.exists(tcl_path):
            os.environ['TCL_LIBRARY'] = tcl_path
            break
    for tk_path in possible_tk_paths:
        if os.path.exists(tk_path):
            os.environ['TK_LIBRARY'] = tk_path
            break
"""

# ç›´æ¥å°†é’©å­ä»£ç æ·»åŠ åˆ°runtime_hooks
with open(os.path.join(SPECPATH, "tkinter_hook.py"), "w") as f:
    f.write(get_hook_code())

a.runtime_hooks.append(os.path.join(SPECPATH, "tkinter_hook.py"))
'@
        
        # åœ¨build.specä¸­æ·»åŠ é’©å­ä»£ç 
        $newSpecContent = $specContent -replace "# è¿‡æ»¤æ‰ None å€¼", $hookCode + "`n# è¿‡æ»¤æ‰ None å€¼"
        Set-Content -Path build.spec -Value $newSpecContent
        
        # ç›´æ¥ä½¿ç”¨ä¿®æ”¹åçš„build.specæ–‡ä»¶æ„å»º
        pyinstaller build.spec --log-level DEBUG --collect-all tkinter --collect-all customtkinter
        
        # ç¡®ä¿åŒ…å«æ‰€æœ‰å¿…è¦çš„tkinteræ–‡ä»¶
        $distPath = "dist/TodoApp.exe"
        if (Test-Path $distPath) {
            Write-Host "âœ… æ„å»ºæˆåŠŸ: $distPath"
            # å¤åˆ¶Tcl/Tkåº“æ–‡ä»¶åˆ°distç›®å½•
            $distTclDir = "dist/tcl"
            $distTkDir = "dist/tk"
            if (-not (Test-Path $distTclDir)) { New-Item -ItemType Directory -Path $distTclDir -Force }
            if (-not (Test-Path $distTkDir)) { New-Item -ItemType Directory -Path $distTkDir -Force }
            Copy-Item -Path "$tclPath\tcl8.6\*" -Destination "$distTclDir" -Recurse -Force
            Copy-Item -Path "$tkPath\tk8.6\*" -Destination "$distTkDir" -Recurse -Force
            Write-Host "âœ… å·²å¤åˆ¶Tcl/Tkåº“æ–‡ä»¶åˆ°distç›®å½•"
        } else {
            Write-Host "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        }
      shell: pwsh

    # - name: Build executable (macOS)
    #   if: matrix.platform == 'macos'
    #   run: |
    #     # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥æ„å»ºé€šç”¨äºŒè¿›åˆ¶ï¼ˆåŒæ—¶æ”¯æŒ Intel å’Œ Apple Siliconï¼‰
    #     export ARCHFLAGS="-arch x86_64 -arch arm64"
    #     
    #     # è¾“å‡ºPythonå’Œä¾èµ–åº“ç‰ˆæœ¬ä¿¡æ¯
    #     python -c "import sys; print(f'Pythonç‰ˆæœ¬: {sys.version}')"
    #     python -c "import platform; print(f'å¹³å°: {platform.platform()}')"
    #     python -c "import customtkinter; print(f'CustomTkinterç‰ˆæœ¬: {customtkinter.__version__}')"
    #     python -c "import tkinter; print(f'Tkinterç‰ˆæœ¬: {tkinter.TkVersion}')"
    #     
    #     # ä½¿ç”¨ --target-architecture universal2 æ„å»ºé€šç”¨äºŒè¿›åˆ¶
    #     pyinstaller --onefile --windowed --name "TodoApp" --target-architecture universal2 \
    #       --collect-all tkinter --collect-all customtkinter \
    #       --hidden-import=tkinter --hidden-import=tkinter.ttk \
    #       --hidden-import=tkinter.messagebox --hidden-import=tkinter.filedialog \
    #       app.py
    #   shell: bash
      
    - name: Build executable (Linux)
      if: matrix.platform == 'linux'
      run: |
        pyinstaller --onefile --windowed --name "TodoApp" --collect-all tkinter --collect-all customtkinter --hidden-import=tkinter --hidden-import=tkinter.ttk --hidden-import=tkinter.messagebox --hidden-import=tkinter.filedialog app.py
      shell: bash

    - name: Rename executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        mv dist/TodoApp.exe "dist/${{ steps.version.outputs.artifact_name_windows }}.exe"
      shell: bash

    - name: Rename executable (Linux)
      if: matrix.platform == 'linux'
      run: |
        mv dist/TodoApp "dist/${{ steps.version.outputs.artifact_name_linux }}"

    # - name: Create macOS App Bundle and DMG
    #   if: matrix.platform == 'macos'
    #   run: |
    #     mkdir -p "dist/Todo App.app/Contents/MacOS"
    #     mkdir -p "dist/Todo App.app/Contents/Resources"
    #     
    #     mv dist/TodoApp "dist/Todo App.app/Contents/MacOS/TodoApp"
    #     chmod +x "dist/Todo App.app/Contents/MacOS/TodoApp"
    #     
    #     # æ£€æŸ¥æ˜¯å¦ä¸ºé€šç”¨äºŒè¿›åˆ¶
    #     lipo -info "dist/Todo App.app/Contents/MacOS/TodoApp" || true
    #     
    #     # è·å–å½“å‰ç‰ˆæœ¬å·
    #     VERSION="${{ steps.version.outputs.version }}"
    #     
    #     cat > "dist/Todo App.app/Contents/Info.plist" << EOF
    #     <?xml version="1.0" encoding="UTF-8"?>
    #     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    #     <plist version="1.0">
    #     <dict>
    #         <key>CFBundleExecutable</key>
    #         <string>TodoApp</string>
    #         <key>CFBundleIdentifier</key>
    #         <string>com.sdcom.todoapp</string>
    #         <key>CFBundleName</key>
    #         <string>Todo App</string>
    #         <key>CFBundleDisplayName</key>
    #         <string>Todo App \${VERSION}</string>
    #         <key>CFBundleVersion</key>
    #         <string>\${VERSION}</string>
    #         <key>CFBundleShortVersionString</key>
    #         <string>\${VERSION}</string>
    #         <key>CFBundlePackageType</key>
    #         <string>APPL</string>
    #         <key>NSHighResolutionCapable</key>
    #         <true/>
    #         <key>LSMinimumSystemVersion</key>
    #         <string>10.14.0</string>
    #         <key>LSArchitecturePriority</key>
    #         <array>
    #             <string>arm64</string>
    #             <string>x86_64</string>
    #         </array>
    #     </dict>
    #     </plist>
    #     EOF
    #     
    #     create-dmg \
    #       --volname "Todo App \${VERSION}" \
    #       --window-pos 200 120 \
    #       --window-size 600 300 \
    #       --icon-size 100 \
    #       --icon "Todo App.app" 175 120 \
    #       --hide-extension "Todo App.app" \
    #       --app-drop-link 425 120 \
    #       "dist/\${{ steps.version.outputs.artifact_name_macos }}.dmg" \
    #       "dist/Todo App.app" || true
    #     
    #     if [ ! -f "dist/\${{ steps.version.outputs.artifact_name_macos }}.dmg" ]; then
    #       hdiutil create -volname "Todo App \${VERSION}" -srcfolder "dist/Todo App.app" -ov -format UDZO "dist/\${{ steps.version.outputs.artifact_name_macos }}.dmg"
    #     fi

    - name: Create archive (Windows)
      if: matrix.platform == 'windows'
      run: |
        cd dist
        7z a "${{ steps.version.outputs.artifact_name_windows }}.zip" "${{ steps.version.outputs.artifact_name_windows }}.exe"
      shell: bash

    - name: Create archive (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd dist
        tar -czf "${{ steps.version.outputs.artifact_name_linux }}.tar.gz" "${{ steps.version.outputs.artifact_name_linux }}"

    - name: Upload artifact (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.version.outputs.artifact_name_windows }}
        path: dist/${{ steps.version.outputs.artifact_name_windows }}.zip

    # - name: Upload artifact (macOS)
    #   if: matrix.platform == 'macos'
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: ${{ steps.version.outputs.artifact_name_macos }}
    #     path: dist/${{ steps.version.outputs.artifact_name_macos }}.dmg

    - name: Upload artifact (Linux)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.version.outputs.artifact_name_linux }}
        path: dist/${{ steps.version.outputs.artifact_name_linux }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Read version
      id: version
      run: |
        VERSION=$(head -n 1 version)
        TAG_TYPE=$(tail -n 1 version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # æ ¹æ®æ ‡ç­¾ç±»å‹è®¾ç½®tag_name
        if [ "$TAG_TYPE" == "Pre-release" ]; then
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(date +%Y%m%d)
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä»Šå¤©çš„æ„å»ºï¼Œå¹¶è·å–æœ€æ–°çš„æ„å»ºæ¬¡æ•°
          BUILD_COUNT=1
          # è·å–æ‰€æœ‰ä»¥å½“å‰ç‰ˆæœ¬å’Œæ—¥æœŸå¼€å¤´çš„æ ‡ç­¾
          EXISTING_TAGS=$(git ls-remote --tags origin | grep "${VERSION}-${DATE}-" | sed -E "s/.*${VERSION}-${DATE}-([0-9]+).*/\1/" | sort -n)
          
          # å¦‚æœå­˜åœ¨æ ‡ç­¾ï¼Œè·å–æœ€å¤§å€¼å¹¶åŠ 1
          if [ ! -z "$EXISTING_TAGS" ]; then
            LATEST_COUNT=$(echo "$EXISTING_TAGS" | tail -n 1)
            if [ ! -z "$LATEST_COUNT" ]; then
              BUILD_COUNT=$((LATEST_COUNT + 1))
            fi
          fi
          
          # è®¾ç½®é¢„è§ˆç‰ˆæ ‡ç­¾
          TAG_NAME="${VERSION}-${DATE}-${BUILD_COUNT}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "artifact_name_windows=Todo-App-$VERSION-preview-Windows-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_linux=Todo-App-$VERSION-preview-Linux-x64" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          # æ­£å¼ç‰ˆæ ‡ç­¾
          TAG_NAME="${VERSION}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "artifact_name_windows=Todo-App-$VERSION-Windows-x64" >> $GITHUB_OUTPUT
          echo "artifact_name_linux=Todo-App-$VERSION-Linux-x64" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag_name }}
        release_name: ${{ steps.version.outputs.tag_name }}
        body: |
          ## Todo App ${{ steps.version.outputs.version }} ${{ steps.version.outputs.is_prerelease == 'true' && '- é¢„è§ˆç‰ˆ' || '' }}

          ### ğŸ‰ æ–°åŠŸèƒ½
          - ğŸ”§ ä¼˜åŒ–ç³»ç»Ÿæ£€æµ‹æ˜¾ç¤ºï¼ŒmacOS æ˜¾ç¤ºçœŸå®ç‰ˆæœ¬å·
          - ğŸ”§ æ·»åŠ  Linux å‘è¡Œç‰ˆæœ¬æ˜¾ç¤ºæ”¯æŒ
          - ğŸ†• å®Œå…¨é‡æ„ï¼Œä½¿ç”¨ customtkinter æ¡†æ¶
          - ğŸ› ï¸ ä¿®å¤ Windows ä¸Š Tcl/Tk ä¾èµ–é—®é¢˜ï¼Œç¡®ä¿å•ä¸ªexeæ–‡ä»¶å¯ä»¥ç‹¬ç«‹è¿è¡Œ

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windows ç”¨æˆ·**: ä¸‹è½½ `${{ steps.version.outputs.artifact_name_windows }}.zip`
          - **Linux ç”¨æˆ·**: ä¸‹è½½ `${{ steps.version.outputs.artifact_name_linux }}.tar.gz`

          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          - **Windows**: è§£å‹ ZIP æ–‡ä»¶ï¼ŒåŒå‡»è¿è¡Œ .exe æ–‡ä»¶
          - **Linux**: è§£å‹ tar.gz æ–‡ä»¶ï¼Œè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.14 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: æ”¯æŒ GTK çš„ç°ä»£ Linux å‘è¡Œç‰ˆ

          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/SDCOM-0415/To-do.app/issues) é¡µé¢åé¦ˆã€‚

          ---
          **å®Œæ•´æºä»£ç **: [GitHub Repository](https://github.com/SDCOM-0415/To-do.app)
        draft: false
        prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}

    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ steps.version.outputs.artifact_name_windows }}/${{ steps.version.outputs.artifact_name_windows }}.zip
        asset_name: ${{ steps.version.outputs.artifact_name_windows }}.zip
        asset_content_type: application/zip

    # - name: Upload macOS Release Asset
    #   uses: actions/upload-release-asset@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     upload_url: ${{ steps.create_release.outputs.upload_url }}
    #     asset_path: ./${{ steps.version.outputs.artifact_name_macos }}/${{ steps.version.outputs.artifact_name_macos }}.dmg
    #     asset_name: ${{ steps.version.outputs.artifact_name_macos }}.dmg
    #     asset_content_type: application/x-apple-diskimage

    - name: Upload Linux Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ steps.version.outputs.artifact_name_linux }}/${{ steps.version.outputs.artifact_name_linux }}.tar.gz
        asset_name: ${{ steps.version.outputs.artifact_name_linux }}.tar.gz
        asset_content_type: application/gzip
